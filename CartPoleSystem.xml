<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>//Channels
broadcast chan left, right;

//Constants
const double G = 9.8;
const double MASS_CART = 1.0;
const double MASS_POLE = 0.1;
const double MASS_TOTAL = MASS_CART + MASS_POLE;
const double POLE_LENGTH = 0.5;
const double MASS_POLE_LENGTH = MASS_CART * POLE_LENGTH;
const double F = 10.0;

//Thresholds
const double CART_POS_LIMIT = 4.8;
const double CART_POS_TERMINATION_LIMIT = 2.4;

const double POLE_ANGLE_LIMIT = 0.418;
const double POLE_ANGLE_TERMINATION_LIMIT = 0.2095;

//Observation space
clock cart_pos, cart_vel, pole_ang, pole_vel;
clock time;
int deaths = 0;

//Applied force on cart
double force = 0;

//Functions extracted from the Gymnasium source code
double temp() {
    return (force + MASS_POLE_LENGTH * pow(pole_vel, 2)) / MASS_TOTAL;
}

double pole_acc() {
    return (G * sin(pole_ang) - cos(pole_ang) * temp()) / (POLE_LENGTH * (4.0 / 3.0 - MASS_POLE * pow(cos(pole_ang), 2) / MASS_TOTAL));
}

double cart_acc() {
    return temp() - (MASS_POLE_LENGTH * pole_acc() * cos(pole_ang) / MASS_TOTAL);
}</declaration>
	<template>
		<name x="5" y="5">Agent</name>
		<declaration>clock t;</declaration>
		<location id="id0" x="51" y="314">
			<name x="41" y="280">Init</name>
			<label kind="invariant" x="-42" y="289">t&lt;=1 &amp;&amp;
t'==50</label>
			<label kind="exponentialrate" x="41" y="348">1</label>
		</location>
		<location id="id1" x="323" y="314">
			<name x="313" y="280">Control</name>
			<committed/>
		</location>
		<init ref="id0"/>
		<transition id="id2">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="144" y="425">right!</label>
			<nail x="187" y="408"/>
		</transition>
		<transition id="id3">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="161" y="195">left!</label>
			<nail x="187" y="229"/>
		</transition>
		<transition id="id4" controllable="false">
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="guard" x="136" y="314">t==1</label>
			<label kind="assignment" x="221" y="314">t=0</label>
		</transition>
	</template>
	<template>
		<name>CartPole</name>
		<location id="id5" x="-960" y="442">
			<name x="-1020" y="425">Init</name>
			<urgent/>
		</location>
		<location id="id6" x="-459" y="442">
			<name x="-469" y="408">Running1</name>
			<label kind="invariant" x="-467" y="459">cart_pos' == cart_vel &amp;&amp; 
cart_vel' == cart_acc() &amp;&amp;
pole_ang' == pole_vel &amp;&amp; 
pole_vel' == pole_acc()</label>
		</location>
		<location id="id7" x="-459" y="178">
			<name x="-469" y="144">Running2</name>
			<committed/>
		</location>
		<location id="id8" x="-459" y="-85">
			<name x="-469" y="-119">End</name>
			<label kind="invariant" x="-510" y="-229">cart_pos' == 0 &amp;&amp; 
cart_vel' == 0 &amp;&amp;
pole_ang' == 0 &amp;&amp; 
pole_vel' == 0</label>
			<committed/>
		</location>
		<init ref="id5"/>
		<transition id="id9">
			<source ref="id8"/>
			<target ref="id5"/>
			<label kind="assignment" x="-1020" y="102">deaths++</label>
			<nail x="-952" y="-85"/>
		</transition>
		<transition id="id10" controllable="false">
			<source ref="id7"/>
			<target ref="id8"/>
			<label kind="guard" x="-382" y="59">pole_ang &gt; POLE_ANGLE_TERMINATION_LIMIT</label>
			<nail x="-365" y="42"/>
		</transition>
		<transition id="id11" controllable="false">
			<source ref="id7"/>
			<target ref="id8"/>
			<label kind="guard" x="-833" y="34">cart_pos &lt; -CART_POS_TERMINATION_LIMIT</label>
			<nail x="-561" y="42"/>
		</transition>
		<transition id="id12" controllable="false">
			<source ref="id7"/>
			<target ref="id8"/>
			<label kind="guard" x="-484" y="25">pole_ang &lt; -POLE_ANGLE_TERMINATION_LIMIT</label>
			<nail x="-416" y="42"/>
		</transition>
		<transition id="id13" controllable="false">
			<source ref="id7"/>
			<target ref="id8"/>
			<label kind="guard" x="-799" y="68">cart_pos  &gt;CART_POS_TERMINATION_LIMIT</label>
			<nail x="-510" y="42"/>
		</transition>
		<transition id="id14">
			<source ref="id6"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="-297" y="221">right?</label>
			<label kind="assignment" x="-297" y="238">force = F</label>
			<nail x="-306" y="365"/>
			<nail x="-306" y="221"/>
		</transition>
		<transition id="id15">
			<source ref="id6"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="-671" y="221">left?</label>
			<label kind="assignment" x="-714" y="238">force = -F</label>
			<nail x="-612" y="357"/>
			<nail x="-612" y="221"/>
		</transition>
		<transition id="id16" controllable="false">
			<source ref="id7"/>
			<target ref="id6"/>
			<label kind="guard" x="-620" y="280">cart_pos &gt;= -CART_POS_TERMINATION_LIMIT &amp;&amp;
cart_pos &lt;= CART_POS_TERMINATION_LIMIT &amp;&amp;
pole_ang &gt;= -POLE_ANGLE_TERMINATION_LIMIT &amp;&amp; 
pole_ang &lt;= POLE_ANGLE_TERMINATION_LIMIT</label>
		</transition>
		<transition id="id17" controllable="false">
			<source ref="id5"/>
			<target ref="id6"/>
			<label kind="assignment" x="-1020" y="476">cart_pos = -0.05 + random(0.1), cart_vel = -0.05 + random(0.1),
pole_ang = -0.05 + random(0.1), pole_vel = -0.05 + random(0.1)</label>
		</transition>
	</template>
	<system>system Agent, CartPole;</system>
	<queries>
		<query>
			<formula>E[&lt;=10;1000] (max: deaths)</formula>
			<comment/>
			<result outcome="success" type="quantity" value="23.861 ± 0.168774 (95% CI)" timestamp="2024-05-20 17:11:08 +0200">
				<details>23.861 ± 0.168774 (95% CI)</details>
				<plot title="Probability Density Distribution" xaxis="max: deaths" yaxis="probability density">
					<series title="density" type="b(1.000000)" color="0x0000ff" encoding="csv">14.0,0.001
15.0,0.001
16.0,0.002
17.0,0.002
18.0,0.025
19.0,0.025
20.0,0.058
21.0,0.086
22.0,0.099
23.0,0.149
24.0,0.122
25.0,0.149
26.0,0.107
27.0,0.082
28.0,0.061
29.0,0.022
30.0,0.004
31.0,0.005
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">23.861,0.0
23.861,0.149
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=1, bucket count=18
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [14, 31]
Mean estimate of displayed sample: 23.861 ± 0.16877 (95% CI)</comment>
				</plot>
				<plot title="Probability Distribution" xaxis="max: deaths" yaxis="probability">
					<series title="probability" type="b(1.000000)" color="0x0000ff" encoding="csv">14.0,0.001
15.0,0.001
16.0,0.002
17.0,0.002
18.0,0.025
19.0,0.025
20.0,0.058
21.0,0.086
22.0,0.099
23.0,0.149
24.0,0.122
25.0,0.149
26.0,0.107
27.0,0.082
28.0,0.061
29.0,0.022
30.0,0.004
31.0,0.005
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">23.861,0.0
23.861,0.149
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=1, bucket count=18
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [14, 31]
Mean estimate of displayed sample: 23.861 ± 0.16877 (95% CI)</comment>
				</plot>
				<plot title="Cumulative Probability Distribution" xaxis="max: deaths" yaxis="probability">
					<series title="cumulative" type="l" color="0x000000" encoding="csv">14.0,0.0
15.0,0.001
16.0,0.002
17.0,0.004
18.0,0.006
19.0,0.031
20.0,0.056
21.0,0.114
22.0,0.2
23.0,0.299
24.0,0.448
25.0,0.57
26.0,0.719
27.0,0.826
28.0,0.908
29.0,0.969
30.0,0.991
31.0,0.995
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">23.861,0.0
23.861,1.0
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=1, bucket count=18
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [14, 31]
Mean estimate of displayed sample: 23.861 ± 0.16877 (95% CI)</comment>
				</plot>
				<plot title="Cumulative Probability Confidence Intervals" xaxis="max: deaths" yaxis="probability">
					<series title="upper limit" type="k" color="0x0000dd" encoding="csv">14.0,0.003682083896865672
15.0,0.005558924279826673
16.0,0.007205838911457498
17.0,0.010209664683929873
18.0,0.013013423270974498
19.0,0.043715085006238906
20.0,0.07210774628325275
21.0,0.1353439130716079
22.0,0.22615937282137055
23.0,0.32843758901358244
24.0,0.47943669323774835
25.0,0.6009397466063688
26.0,0.7466802940214341
27.0,0.8490099415239745
28.0,0.9251915548221445
29.0,0.9788418280297914
30.0,0.9958766043396575
31.0,0.9983745804824372
					</series>
					<series title="lower limit" type="k" color="0xdd0000" encoding="csv">14.0,0.0
15.0,2.5317487491294045E-5
16.0,2.4230111687723193E-4
17.0,0.0010909079877259719
18.0,0.0022049824851513773
19.0,0.02115817197020863
20.0,0.04257554968661718
21.0,0.09496128197328355
22.0,0.1756205748308422
23.0,0.27075114115338694
24.0,0.41687029273190956
25.0,0.5386469648923902
26.0,0.6900239857126379
27.0,0.8010531420069635
28.0,0.8883642274816803
29.0,0.9562849149937611
30.0,0.9829842169301054
31.0,0.9883705294401879
					</series>
					<series title="cumulative" type="l" color="0x000000" encoding="csv">14.0,0.0
15.0,0.001
16.0,0.002
17.0,0.004
18.0,0.006
19.0,0.031
20.0,0.056
21.0,0.114
22.0,0.2
23.0,0.299
24.0,0.448
25.0,0.57
26.0,0.719
27.0,0.826
28.0,0.908
29.0,0.969
30.0,0.991
31.0,0.995
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">23.861,0.0
23.861,1.0
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=1, bucket count=18
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [14, 31]
Mean estimate of displayed sample: 23.861 ± 0.16877 (95% CI)</comment>
				</plot>
				<plot title="Frequency Histogram" xaxis="max: deaths" yaxis="count">
					<series title="count" type="b(1.000000)" color="0x0000ff" encoding="csv">14.0,1.0
15.0,1.0
16.0,2.0
17.0,2.0
18.0,25.0
19.0,25.0
20.0,58.0
21.0,86.0
22.0,99.0
23.0,149.0
24.0,122.0
25.0,149.0
26.0,107.0
27.0,82.0
28.0,61.0
29.0,22.0
30.0,4.0
31.0,5.0
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">23.861,0.0
23.861,149.0
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=1, bucket count=18
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [14, 31]
Mean estimate of displayed sample: 23.861 ± 0.16877 (95% CI)</comment>
				</plot>
			</result>
		</query>
		<query>
			<formula>strategy StayAlive = minE (deaths) [&lt;=10] {} -&gt; {cart_pos, cart_vel, pole_ang, pole_vel}: &lt;&gt; time &gt;= 10</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2024-05-20 17:12:46 +0200">
			</result>
		</query>
		<query>
			<formula>saveStrategy("/Users/benjamin/Desktop/experiment_cartpole.json", StayAlive)</formula>
			<comment/>
		</query>
		<query>
			<formula>E[&lt;=10;1000] (max: deaths) under StayAlive</formula>
			<comment/>
			<result outcome="success" type="quantity" value="0.023 ± 0.00930686 (95% CI)" timestamp="2024-05-20 17:12:59 +0200">
				<details>0.023 ± 0.00930686 (95% CI)</details>
				<plot title="Probability Density Distribution" xaxis="max: deaths" yaxis="probability density">
					<series title="density" type="b(1.000000)" color="0x0000ff" encoding="csv">0.0,0.977
1.0,0.023
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">0.023,0.0
0.023,0.977
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=1, bucket count=2
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [0, 1]
Mean estimate of displayed sample: 0.023 ± 0.00931 (95% CI)</comment>
				</plot>
				<plot title="Probability Distribution" xaxis="max: deaths" yaxis="probability">
					<series title="probability" type="b(1.000000)" color="0x0000ff" encoding="csv">0.0,0.977
1.0,0.023
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">0.023,0.0
0.023,0.977
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=1, bucket count=2
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [0, 1]
Mean estimate of displayed sample: 0.023 ± 0.00931 (95% CI)</comment>
				</plot>
				<plot title="Cumulative Probability Distribution" xaxis="max: deaths" yaxis="probability">
					<series title="cumulative" type="l" color="0x000000" encoding="csv">0.0,0.0
1.0,0.977
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">0.023,0.0
0.023,1.0
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=1, bucket count=2
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [0, 1]
Mean estimate of displayed sample: 0.023 ± 0.00931 (95% CI)</comment>
				</plot>
				<plot title="Cumulative Probability Confidence Intervals" xaxis="max: deaths" yaxis="probability">
					<series title="upper limit" type="k" color="0x0000dd" encoding="csv">0.0,0.003682083896865672
1.0,0.9853654176748232
					</series>
					<series title="lower limit" type="k" color="0xdd0000" encoding="csv">0.0,0.0
1.0,0.9656876623871457
					</series>
					<series title="cumulative" type="l" color="0x000000" encoding="csv">0.0,0.0
1.0,0.977
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">0.023,0.0
0.023,1.0
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=1, bucket count=2
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [0, 1]
Mean estimate of displayed sample: 0.023 ± 0.00931 (95% CI)</comment>
				</plot>
				<plot title="Frequency Histogram" xaxis="max: deaths" yaxis="count">
					<series title="count" type="b(1.000000)" color="0x0000ff" encoding="csv">0.0,977.0
1.0,23.0
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">0.023,0.0
0.023,977.0
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=1, bucket count=2
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [0, 1]
Mean estimate of displayed sample: 0.023 ± 0.00931 (95% CI)</comment>
				</plot>
			</result>
		</query>
	</queries>
</nta>
