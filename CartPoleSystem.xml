<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>//Channels
chan left, right;

//Constants
const double G = 9.8;
const double MASS_CART = 1.0;
const double MASS_POLE = 0.1;
const double MASS_TOTAL = MASS_CART + MASS_POLE;
const double POLE_LENGTH = 0.5;
const double MASS_POLE_LENGTH = MASS_CART * POLE_LENGTH;
const double F = 10.0;

//Thresholds
const double CART_POS_LIMIT = 4.8;
const double CART_POS_TERMINATION_LIMIT = 2.4;

const double POLE_ANGLE_LIMIT = 0.418;
const double POLE_ANGLE_TERMINATION = 0.2095;

//Observation space
clock cart_pos, cart_vel, pole_ang, pole_vel;

//Applied force on cart
double force = 0;

//Functions extracted from the Gymnasium source code
double temp() {
    return (force + MASS_POLE_LENGTH * pow(pole_vel, 2)) / MASS_TOTAL;
}

double pole_acc() {
    return (G * sin(pole_ang) - cos(pole_ang) * temp()) / (POLE_LENGTH * (4.0 / 3.0 - MASS_POLE * pow(cos(pole_ang), 2) / MASS_TOTAL));
}

double cart_acc() {
    return temp() - (MASS_POLE_LENGTH * pole_acc() * cos(pole_ang) / MASS_TOTAL);
}</declaration>
	<template>
		<name x="5" y="5">Agent</name>
		<declaration>clock t;</declaration>
		<location id="id0" x="51" y="314">
			<name x="41" y="280">Init</name>
			<label kind="invariant" x="41" y="331">t&lt;=1</label>
		</location>
		<location id="id1" x="323" y="314">
			<name x="313" y="280">Control</name>
			<committed/>
		</location>
		<init ref="id0"/>
		<transition id="id2">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="144" y="425">right!</label>
			<nail x="187" y="408"/>
		</transition>
		<transition id="id3">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="161" y="195">left!</label>
			<nail x="187" y="229"/>
		</transition>
		<transition id="id4" controllable="false">
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="guard" x="136" y="314">t==1</label>
			<label kind="assignment" x="221" y="314">t=0</label>
		</transition>
	</template>
	<template>
		<name>CartPole</name>
		<location id="id5" x="-714" y="442">
			<name x="-724" y="408">Init</name>
		</location>
		<location id="id6" x="-459" y="442">
			<name x="-469" y="408">Running1</name>
		</location>
		<location id="id7" x="-459" y="178">
			<name x="-469" y="144">Running2</name>
			<committed/>
		</location>
		<init ref="id5"/>
		<transition id="id8">
			<source ref="id6"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="-297" y="263">right?</label>
			<nail x="-306" y="365"/>
			<nail x="-306" y="221"/>
		</transition>
		<transition id="id9">
			<source ref="id6"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="-671" y="272">left?</label>
			<nail x="-612" y="357"/>
			<nail x="-612" y="221"/>
		</transition>
		<transition id="id10" controllable="false">
			<source ref="id7"/>
			<target ref="id6"/>
		</transition>
		<transition id="id11">
			<source ref="id5"/>
			<target ref="id6"/>
		</transition>
	</template>
	<system>system Agent, CartPole;</system>
	<queries>
		<query>
			<formula/>
			<comment/>
		</query>
	</queries>
</nta>
