<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>typedef int[0,2] eng;

//Channels
broadcast chan left, right, free;

//Cost 
clock cost, t, time;


//Constants
const double FORCE = 0.001;
const double G = 0.0025;
const double WIN_POS = 0.5;
const double MAX_TIME = 200;

//Thresholds
const double pos_max = 0.6;
const double pos_min = -1.2;
const double vel_max = 0.07;
const double vel_min = -0.07;

//Min function
double min(double a, double b){
    return a &lt; b? a : b;
}

//Max function
double max(double a, double b){
    return a &gt; b? a : b;
}

//Clip function
double clip(double val, double min_val, double max_val) {
    return max(min_val, min(max_val, val));
}



//Car properties
clock vel=0, pos=0;
eng engine; //  0 = left, 1 = free, 2 = right


double acc() {
    if (vel &lt;= vel_min || vel &gt;= vel_max)
        return 0;

    return (engine -1) * FORCE - cos(3 * pos) * G;
}

double velocity() {
    if (pos &lt;= pos_min || pos &gt;= pos_max)
        return 0;

    return vel;
}

eng brute_force() {
    if (time &lt; 30)
        return 2;
    else if (time &lt; 70)
        return 0;
    else
        return 2;
}


//Misc
//Clip all
void clip_all() {
    pos = clip(pos, pos_min, pos_max);
    vel = clip(vel, vel_min, vel_max);
}


</declaration>
	<template>
		<name>Agent</name>
		<location id="id0" x="-229" y="-110">
			<name x="-280" y="-119">Init</name>
			<label kind="invariant" x="-238" y="-93">t&lt;=1 &amp;&amp;
t' == 1</label>
		</location>
		<location id="id1" x="144" y="-110">
			<name x="161" y="-119">Control</name>
			<committed/>
		</location>
		<init ref="id0"/>
		<transition id="id2">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="-68" y="-289">free!</label>
			<nail x="195" y="-153"/>
			<nail x="195" y="-195"/>
			<nail x="-51" y="-306"/>
			<nail x="-280" y="-195"/>
			<nail x="-280" y="-144"/>
		</transition>
		<transition id="id3">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="-68" y="-238">right!</label>
			<nail x="144" y="-161"/>
			<nail x="-51" y="-255"/>
			<nail x="-229" y="-170"/>
		</transition>
		<transition id="id4" controllable="false">
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="guard" x="-102" y="-110">t==1</label>
			<label kind="assignment" x="-34" y="-110">t=0</label>
		</transition>
		<transition id="id5">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="-68" y="-178">left!</label>
			<nail x="-51" y="-204"/>
		</transition>
	</template>
	<template>
		<name>MountainCar</name>
		<location id="id6" x="-807" y="76">
			<name x="-892" y="68">Initial</name>
			<committed/>
		</location>
		<location id="id7" x="-433" y="76">
			<name x="-425" y="85">Driving1</name>
			<label kind="invariant" x="-493" y="127">pos' == velocity() &amp;&amp;
vel' == acc()</label>
		</location>
		<location id="id8" x="-433" y="-178">
			<name x="-527" y="-187">Driving2</name>
			<committed/>
		</location>
		<location id="id9" x="-433" y="-340">
			<name x="-518" y="-382">Termination</name>
			<label kind="invariant" x="-391" y="-374">pos' == 0 &amp;&amp;
vel' == 0 &amp;&amp;
cost' == 0</label>
		</location>
		<init ref="id6"/>
		<transition id="id10" controllable="false">
			<source ref="id8"/>
			<target ref="id9"/>
			<label kind="guard" x="-416" y="-280">pos &gt;= WIN_POS</label>
		</transition>
		<transition id="id11">
			<source ref="id7"/>
			<target ref="id8"/>
			<label kind="guard" x="-297" y="-102">false</label>
			<label kind="synchronisation" x="-289" y="-76">right?</label>
			<label kind="assignment" x="-289" y="-59">engine = 2</label>
			<nail x="-340" y="76"/>
			<nail x="-297" y="25"/>
			<nail x="-297" y="-136"/>
			<nail x="-340" y="-178"/>
		</transition>
		<transition id="id12">
			<source ref="id7"/>
			<target ref="id8"/>
			<label kind="guard" x="-382" y="-102">false</label>
			<label kind="synchronisation" x="-357" y="-76">free?</label>
			<label kind="assignment" x="-382" y="-59">engine = 2</label>
			<nail x="-365" y="17"/>
			<nail x="-365" y="-136"/>
		</transition>
		<transition id="id13">
			<source ref="id7"/>
			<target ref="id8"/>
			<label kind="assignment" x="-705" y="-85">engine = brute_force()</label>
			<nail x="-501" y="17"/>
			<nail x="-501" y="-127"/>
		</transition>
		<transition id="id14" controllable="false">
			<source ref="id8"/>
			<target ref="id7"/>
			<label kind="guard" x="-493" y="0">pos &lt; WIN_POS</label>
			<label kind="assignment" x="-476" y="-17">clip_all()</label>
		</transition>
		<transition id="id15" controllable="false">
			<source ref="id6"/>
			<target ref="id7"/>
			<label kind="assignment" x="-765" y="85">pos = -0.4 - random(0.2)</label>
		</transition>
	</template>
	<system>system MountainCar, Agent;</system>
	<queries>
		<option key="--search-order" value="0"/>
		<option key="--diagnostic" value="2"/>
		<query>
			<formula>E[&lt;=1000;1000] (max: cost) &lt;&gt;MountainCar.Termination</formula>
			<comment/>
		</query>
		<query>
			<formula>strategy winQuick = minE (cost) [&lt;=200] {} -&gt; {pos, vel}: &lt;&gt; MountainCar.Termination || time &gt;= 200</formula>
			<comment/>
			<option key="--search-order" value="1"/>
			<option key="--diagnostic" value="1"/>
			<result outcome="success" type="quality" timestamp="2024-05-08 14:12:49 +0200">
				<option key="--search-order" value="1"/>
				<option key="--diagnostic" value="1"/>
			</result>
		</query>
		<query>
			<formula>strategy winQuick = minE (cost) [&lt;=400]: &lt;&gt; MountainCar.Termination</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2024-05-06 14:25:15 +0200">
				<option key="--search-order" value="0"/>
				<option key="--diagnostic" value="2"/>
			</result>
		</query>
		<query>
			<formula>E[&lt;=200;1000] (max: cost) under winQuick</formula>
			<comment/>
			<result outcome="success" type="quantity" value="≈ 200" timestamp="2024-05-08 14:13:06 +0200">
				<option key="--search-order" value="0"/>
				<option key="--diagnostic" value="2"/>
				<details>≈ 200</details>
				<plot title="Probability Density Distribution" xaxis="max: cost" yaxis="probability density">
					<series title="density" type="b(0.000000)" color="0x0000ff" encoding="csv">200.0,4.503599627370496E15
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">200.0,0.0
200.0,4.503599627370496E15
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=2.2204e-16, bucket count=1
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [200, 200]
Mean estimate of displayed sample: ≈ 200</comment>
				</plot>
				<plot title="Probability Distribution" xaxis="max: cost" yaxis="probability">
					<series title="probability" type="b(0.000000)" color="0x0000ff" encoding="csv">200.0,1.0
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">200.0,0.0
200.0,1.0
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=2.2204e-16, bucket count=1
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [200, 200]
Mean estimate of displayed sample: ≈ 200</comment>
				</plot>
				<plot title="Cumulative Probability Distribution" xaxis="max: cost" yaxis="probability">
					<series title="cumulative" type="l" color="0x000000" encoding="csv">200.0,0.0
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">200.0,0.0
200.0,1.0
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=2.2204e-16, bucket count=1
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [200, 200]
Mean estimate of displayed sample: ≈ 200</comment>
				</plot>
				<plot title="Cumulative Probability Confidence Intervals" xaxis="max: cost" yaxis="probability">
					<series title="upper limit" type="k" color="0x0000dd" encoding="csv">200.0,0.003682083896865672
					</series>
					<series title="lower limit" type="k" color="0xdd0000" encoding="csv">200.0,0.0
					</series>
					<series title="cumulative" type="l" color="0x000000" encoding="csv">200.0,0.0
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">200.0,0.0
200.0,1.0
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=2.2204e-16, bucket count=1
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [200, 200]
Mean estimate of displayed sample: ≈ 200</comment>
				</plot>
				<plot title="Frequency Histogram" xaxis="max: cost" yaxis="count">
					<series title="count" type="b(0.000000)" color="0x0000ff" encoding="csv">200.0,1000.0
					</series>
					<series title="average" type="pl" color="0x00dd00" encoding="csv">200.0,0.0
200.0,1000.0
					</series>
					<comment>Parameters: α=0.05, ε=0.05, bucket width=2.2204e-16, bucket count=1
Runs: 1000 in total, 1000 (100%) displayed, 0 (0%) remaining
Span of displayed sample: [200, 200]
Mean estimate of displayed sample: ≈ 200</comment>
				</plot>
			</result>
		</query>
		<query>
			<formula>Pr[&lt;=10000](&lt;&gt; MountainCar.Termination)</formula>
			<comment/>
			<result outcome="success" type="interval" value="≤ 0.0499441 (95% CI)" timestamp="2024-05-08 13:46:11 +0200">
				<option key="--search-order" value="0"/>
				<option key="--diagnostic" value="2"/>
				<details>≤ 0.0499441 (95% CI)</details>
			</result>
		</query>
		<query>
			<formula/>
			<comment/>
		</query>
	</queries>
</nta>
